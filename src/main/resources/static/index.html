<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>References</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>

</head>

<body>

    <div class='container'>
        <div id='root'></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.2/react.min.js"></script>
    <script src="https://fb.me/react-dom-15.0.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js"></script>

    <!-- <script type="text/babel" th:src="@{/app.js}"></script> -->

    <script type="text/babel">
    console.log('loading react script')

    var Reference = React.createClass({
      // componentDidMount() {
      //   console.log('receiving props', this.props.selected)
      //   this.setState({'isChecked': this.props.selected});
      // },
      handleDelete: function(e) {
        e.preventDefault();
        this.setState({thumbnail: null});
        this.props.handleDelete(this.props.reference);
      },
      getInitialState: function() {
        console.log(this.props.selected)
        return {display: true, checked: this.props.selected};
      },
      componentWillReceiveProps: function() {
        this.setState({checked: this.props.selected});
      },
      toggleCheck: function() {
        return this.setState({checked: !this.state.checked});
      },
      render: function() {
        const isChecked = this.state.isChecked ? 'isChecked' : '';
        if (this.state.display==false) return null;
        else return (
          <tr>
              <td><input type="checkbox" className="check" checked={this.state.checked} onClick={this.toggleCheck}/></td>
              <td><img src={this.props.reference.thumbnail} /></td>
              <td>{this.props.reference.author}</td>
              <td>{this.props.reference.title}</td>
              <td>{this.props.reference.year}</td>
              <td>{this.props.reference.journal}</td>
              <td>
                <button className="btn btn-info" onClick={this.handleDelete}>Delete</button>
              </td>
          </tr>
        );
      }
    });

    var ReferenceTable = React.createClass({
      handleDelete: function(reference) {
        this.props.handleDelete(reference);
      },
      handleMultipleDeletes: function(e) {
        e.preventDefault();

        for (let key in this) {
          if (key.indexOf('reference') > -1) {
            if (this[key].state.checked) {
              this.props.handleDelete(this[key].props.reference);
            }
          }
        }
      },
      getInitialState: function() {
        return {'selectAll':false};
      },
      selectAll: function(e) {
        e.preventDefault();
        console.log(this.state.selectAll)
        this.setState({'selectAll': !this.state.selectAll});
      },
      render: function() {

        var rows = [];
        var self = this;
        this.props.references.forEach(function(reference, i) {
          rows.push(
            <Reference reference={reference}
              handleDelete={self.handleDelete}
              selected={self.state.selectAll}
              ref={(el) => {self['reference' + i] = el;}} />);
        });

        return (
          <div>
            <form role="form">
              <button className="btn select" id="checkAll" onClick={this.selectAll}>Select All</button>
              <button className="btn delete" onClick={this.handleMultipleDeletes}>Delete</button>
              <table className="table table-striped">
                  <thead>
                      <tr>
                          <th>Select</th>
                          <th><strong>Cover</strong></th>
                          <th><strong onClick={() => {this.props.reOrder('author')}}>Author</strong></th>
                          <th><strong onClick={() => {this.props.reOrder('title')}}>Title</strong></th>
                          <th><strong onClick={() => {this.props.reOrder('year')}}>Year</strong></th>
                          <th><strong onClick={() => {this.props.reOrder('journal')}}>Journal</strong></th>
                          <th>Delete</th>
                      </tr>
                  </thead>
                  <tbody>{rows}</tbody>
              </table>
            </form>
          </div>
        );
      }
    });

    var UploadReferencesForm = React.createClass({
      upload: function() {
        var vcfData = new FormData($('#uploadform')[0]);
        this.props.upload(vcfData);
      },
      render: function() {
        return (

          <form name="form" id="uploadform" method="POST" encType="multipart/form-data" action="/uploadfile">
            <table>
              <tbody><tr><td>File to upload:</td><td><input type="file" name="file" /></td></tr>
                <tr><td /><td><button type="button" id="uploadfiles" form="form" value="Upload" onClick={this.upload}>UPLOAD</button></td></tr>
              </tbody></table>
          </form>
        );
      }
    });

    var AddReferencesForm = React.createClass({

      getInitialState: function() {
        return {
          author: '',
          title: '',
          year: '',
          journal: ''
        };
      },

      handleInputChange: function(event) {
        const target = event.target;
        const value = target.type === 'checkbox' ? target.checked : target.value;
        const name = target.name;

        this.setState({
          [name]: value
        });
      },

      handleSubmit: function(event) {
        event.preventDefault();

        console.log(event);

        this.props.add({
          author: this.state.author,
          title: this.state.title,
          year: this.state.year,
          journal: this.state.journal
        });
      },

      render: function() {
        return (
          <form onSubmit={this.handleSubmit}>
            <div className="form-group row">
              <div className="col-2 col-form-label">Author</div>
              <input className="col-10 form-control" type="text" name="author" placeholder={this.state.author} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Title</div>
              <input className="col-10 form-control" type="text" name="title" placeholder={this.state.title} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Year</div>
              <input className="col-10 form-control" type="text" name="year" placeholder={this.state.year} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Journal</div>
              <input className="col-10 form-control" type="text" name="journal" placeholder={this.state.journal} onChange={this.handleInputChange} />
            </div>

            <input className="btn btn-info" type="submit" value="Submit" />
          </form>
        )

      }

    })

    var App = React.createClass({
      handleDelete: function(reference) {
        console.log('handling delete');
        const indexOfDeleted = this.state.references.indexOf(reference);
        console.log(indexOfDeleted)
        var self = this;
        $.ajax({
            url: reference._links.self.href,
            method: 'DELETE',
            success: function(result) {
              let newRefs = self.state.references.slice();
              newRefs.splice(indexOfDeleted, 1);
              console.log(newRefs)
              self.setState({references: newRefs});
              // self.loadReferencesFromServer();
            },
            error: function(xhr, ajaxOptions, thrownError) {
              toastr.error(xhr.responseJSON.message);
            }
        });
      },
      loadReferencesFromServer: function(callback) {
        var self = this;
        $.ajax({
            url: "http://localhost:8080/api/references",
          }).then(function(data) {
            self.setState({ references: data._embedded.references });
            callback();
          });

      },

      getInitialState: function() {
        return { references: [] };
      },
      //
      componentDidMount: function() {
        console.log('test')
        this.loadReferencesFromServer(this.getThumbs);
      },

      add(obj) {
        var self = this;
        $.ajax({
            url: "http://localhost:8080/api/references",
            headers: {
                'Content-Type':'application/json'
            },
            method: 'POST',
            dataType: 'json',
            data: JSON.stringify(obj),
            success: function(result) {
              self.setState({ references: self.state.references.concat(result)});
            },
            error: function(xhr, ajaxOptions, thrownError) {
              toastr.error(xhr.responseJSON.message);
            }
        });
      },
      getThumbs: function() {
        console.log('getting thumbnails', this.state.references.length)
        this.state.references.forEach((el, i) => {
          console.log('in foreach')
          const self = this;
          $.ajax({
              url: "https://www.googleapis.com/books/v1/volumes?q=" + el.title + "&fields=items(volumeInfo(imageLinks(thumbnail)))",
              headers: {
                  'Content-Type':'application/json'
              },
              method: 'GET',
              dataType: 'json',
              success: function(result) {
                console.log(result)
                const thumb = result.items[0].volumeInfo.imageLinks.thumbnail;
                const newRefs = self.state.references
                const refWithThumb = newRefs[i];
                refWithThumb.thumbnail = thumb;
                self.setState({references: newRefs});
              },
              error: function(xhr, ajaxOptions, thrownError) {
                toastr.error(xhr.responseJSON.message);
              }
          });
        })

      },
      reOrder(sortDef) {
        console.log(sortDef)
        console.log(this.state.references)
        let newRefs = this.state.references;
        newRefs = newRefs.sort(function(a, b) {
          if (a[sortDef] < b[sortDef])
            return -1;
          if (a[sortDef] > b[sortDef])
            return 1;
          return 0;
        })
        console.log(newRefs);
        this.setState({references: newRefs});
      },

      upload(vcfData) {
        var self = this;
        $.ajax({
              url : "/uploadfile",
              type : "post",
              data : vcfData,
              processData: false,
              contentType: false,
              cache : false,
              success : function(filename) {
                $.ajax({
                      url : "/parsecsv",
                      type : "POST",
                      data: {
                        "filename": filename
                      },
                      success : function(data) {
                        self.loadReferencesFromServer(self.getThumbs);
                      },
                      error : function(data) {
                        self.forceUpdate();
                      },
                  });
              }
          });
      },

      render() {
        return (
          <div>
            <div className="col-md-12">
              <ReferenceTable references={this.state.references} handleDelete={this.handleDelete} reOrder={this.reOrder}/>
            </div>
            <div className="col-md-6">
              <h1>Add a Reference</h1>
              <AddReferencesForm add={this.add} />
            </div>
            <div className="col-md-6">
              <UploadReferencesForm upload={this.upload} />
            </div>
          </div>
        );
      }
    });

    ReactDOM.render(<App />, document.getElementById('root') );
    </script>

</body>

</html>
