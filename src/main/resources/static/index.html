<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>References</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>

</head>

<body>

    <div class='container'>
        <div id='root'></div>
    </div>

    <form method="POST" enctype="multipart/form-data" action="/uploadfile">
      <table>
        <tr><td>File to upload:</td><td><input type="file" name="file" /></td></tr>
        <tr><td></td><td><input type="submit" value="Upload" /></td></tr>
      </table>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.2/react.min.js"></script>
    <script src="https://fb.me/react-dom-15.0.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js"></script>

    <!-- <script type="text/babel" th:src="@{/app.js}"></script> -->

    <script type="text/babel">
    console.log('loading react script')

    var Reference = React.createClass({
      handleDelete: function() {
        this.props.handleDelete(this.props.reference);
      },
      getInitialState: function() {
        return {display: true };
      },
      render: function() {

        if (this.state.display==false) return null;
        else return (
          <tr>
              <td>{this.props.reference.author}</td>
              <td>{this.props.reference.title}</td>
              <td>{this.props.reference.year}</td>
              <td>{this.props.reference.journal}</td>
              <td>
                <button className="btn btn-info" onClick={this.handleDelete}>Delete</button>
              </td>
          </tr>
        );
      }
    });

    var ReferenceTable = React.createClass({
      handleDelete: function(reference) {
        this.props.handleDelete(reference);
      },
      render: function() {

        var rows = [];
        var self = this;
        this.props.references.forEach(function(reference) {
          console.log(reference);
          rows.push(
            <Reference reference={reference} key={reference.author} handleDelete={self.handleDelete}/>);
        });

        return (
          <table className="table table-striped">
              <thead>
                  <tr>
                      <th>Author</th>
                      <th>Title</th>
                      <th>Year</th>
                      <th>Journal</th>
                      <th>Delete</th>
                  </tr>
              </thead>
              <tbody>{rows}</tbody>
          </table>
        );
      }
    });

    var AddReferencesForm = React.createClass({

      getInitialState: function() {
        return {
          author: '',
          title: '',
          year: '',
          journal: ''
        };
      },

      handleInputChange: function(event) {
        const target = event.target;
        const value = target.type === 'checkbox' ? target.checked : target.value;
        const name = target.name;

        this.setState({
          [name]: value
        });
      },

      handleSubmit: function(event) {
        event.preventDefault();

        console.log(event);

        this.props.add({
          author: this.state.author,
          title: this.state.title,
          year: this.state.year,
          journal: this.state.journal
        });
      },

      render: function() {
        return (
          <form onSubmit={this.handleSubmit}>
            <div className="form-group row">
              <div className="col-2 col-form-label">Author</div>
              <input className="col-10 form-control" type="text" name="author" placeholder={this.state.author} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Title</div>
              <input className="col-10 form-control" type="text" name="title" placeholder={this.state.title} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Year</div>
              <input className="col-10 form-control" type="text" name="year" placeholder={this.state.year} onChange={this.handleInputChange} />
            </div>
            <div className="form-group row">
              <div className="col-2 col-form-label">Journal</div>
              <input className="col-10 form-control" type="text" name="journal" placeholder={this.state.journal} onChange={this.handleInputChange} />
            </div>

            <input className="btn btn-info" type="submit" value="Submit" />
          </form>
        )

      }

    })

    var App = React.createClass({
      handleDelete: function(reference) {
        console.log('handling delete')
        var self = this;
        $.ajax({
            url: reference._links.self.href,
            method: 'DELETE',
            success: function(result) {
              self.setState({display: false});
              self.loadReferencesFromServer();
            },
            error: function(xhr, ajaxOptions, thrownError) {
              toastr.error(xhr.responseJSON.message);
            }
        });
      },
      loadReferencesFromServer: function() {

        var self = this;
        $.ajax({
            url: "http://localhost:8080/api/references",
          }).then(function(data) {
            self.setState({ references: data._embedded.references });
          });

      },

      getInitialState: function() {
        return { references: [] };
      },

      componentDidMount: function() {
        this.loadReferencesFromServer();
      },

      add(obj) {
        var self = this;
        $.ajax({
            url: "http://localhost:8080/api/references",
            headers: {
                'Content-Type':'application/json'
            },
            method: 'POST',
            dataType: 'json',
            data: JSON.stringify(obj),
            success: function(result) {
              self.setState({ references: self.state.references.concat(result)});
            },
            error: function(xhr, ajaxOptions, thrownError) {
              toastr.error(xhr.responseJSON.message);
            }
        });
      },

      render() {
        return (
          <div>
            <div className="col-md-8">
              <ReferenceTable references={this.state.references} handleDelete={this.handleDelete}/>
            </div>
            <div className="col-md-4">
              <h1>Add a Reference</h1>
              <AddReferencesForm add={this.add} />
            </div>
          </div>
        );
      }
    });

    ReactDOM.render(<App />, document.getElementById('root') );
    </script>

</body>

</html>
